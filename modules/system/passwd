#!/usr/bin/env bash

source "${SCRIPT_DIR}/lib/colors"

passwd_file="/etc/passwd"

check_non_system_users() {
	echo -e "\n${Green}[X] Checking malicious users on ${passwd_file} file....${Reset}"

	echo -e "${Green}[X] Printing non system users from ${passwd_file} file Username, UID, Shell....\n${Reset}"

	awk -F: '$3 > 1000 {
		printf "[NON SYSTEM USERs] %-15s UID=%-5s SHELL=%s\n", $1, $3, $7
	}' ${passwd_file}

	echo -e "\n${Yellow}[!] If any unknown users/backdoor are found, remove them immediately. If no output then no malicious users found${Reset}"

}
check_non_system_users

check_passwd_permission() {
	local permission
	permission=$(stat -c "%a" "${passwd_file}")

	echo -e "\n${Green}[X] Checking ${passwd_file} file permissions....${Reset}"

	if [[ ${permission} == 644 ]]; then
		echo -e "[✓] ${passwd_file} file permission is secure default (${permission})"
	else
		echo -e "${Yellow}[WARN] ${passwd_file} file permissions appear to be tampered with (${permission})${Reset}"
		echo -e "${Red}[CRITICAL] Immediate attention required!${Reset}"

		if [[ ${FIX_MODE} == true ]]; then

			chmod 644 ${passwd_file}
			permission=$(stat -c "%a" "${passwd_file}")

			echo -e "\n[FIXED] ${passwd_file} file permission set to default (${permission})"
		fi
	fi
}
check_passwd_permission

check_passwd_ownership() {
	local passwd_owner
	passwd_owner=$(stat -c "%U" "${passwd_file}")

	local passwd_group
	passwd_group=$(stat -c "%G" "${passwd_file}")

	echo -e "\n${Green}[X] Checking ${passwd_file} file ownership....${Reset}"

	if [[ ${passwd_owner} && ${passwd_group} == root ]]; then
		echo -e "[✓] ${passwd_file} file is secure default (${passwd_owner}:${passwd_group})"
		echo "-------------------------------------------------------------------------"
	else
		echo -e "${Yellow}[WARN] Someone messed with the ${passwd_file} file ownership (${passwd_owner})${Reset}"
		echo -e "${Red}[CRITICAL] Immediate attention required!${Reset}"

		if [[ ${FIX_MODE} == true ]]; then

			chown root:root ${passwd_file}
			passwd_owner=$(stat -c "%U" "${passwd_file}")

			echo -e "\n[FIXED] ${passwd_file} file ownership set to default (${passwd_owner})"
			echo "-------------------------------------------------------------------------"
		fi
	fi
}
check_passwd_ownership
